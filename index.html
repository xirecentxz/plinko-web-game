<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pinball Matang - 5 Balls</title>
    <style>
        body { margin: 0; background: #000; color: #0ff; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; }
        #msg { position: absolute; top: 50%; width: 100%; text-align: center; font-size: 24px; display: none; }
        canvas { box-shadow: 0 0 50px #004444; display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <div id="ui">
        <div>SKOR: <span id="score">0</span></div>
        <div>BOLA: <span id="ballCount">5</span>/5</div>
    </div>
    <div id="msg">GAME OVER<br><small>Tekan F5 untuk Main Lagi</small></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        const { Engine, Render, Runner, Bodies, Composite, Body, Constraint, Events } = Matter;

        const engine = Engine.create();
        const width = 400;
        const height = window.innerHeight;
        let score = 0;
        let ballLeft = 5;
        let power = 0;
        let isGameOver = false;

        const render = Render.create({
            element: document.body,
            engine: engine,
            options: { width, height, wireframes: false, background: '#050505' }
        });

        // 1. BATAS RUANG (BOX GAME)
        const wallOpt = { isStatic: true, render: { fillStyle: '#111' } };
        const walls = [
            Bodies.rectangle(width/2, 5, width, 10, wallOpt), // Atas
            Bodies.rectangle(5, height/2, 10, height, wallOpt), // Kiri
            Bodies.rectangle(width-5, height/2, 10, height, wallOpt), // Kanan
            Bodies.rectangle(width - 55, height - 150, 10, 300, wallOpt), // Jalur Peluncur
            // PENGARAH POJOK ATAS (Agar bola ke tengah)
            Bodies.rectangle(40, 40, 120, 20, { isStatic: true, angle: Math.PI/4, render: { fillStyle: '#222' } }),
            Bodies.rectangle(width-90, 40, 120, 20, { isStatic: true, angle: -Math.PI/4, render: { fillStyle: '#222' } })
        ];

        // 2. FLIPPER DENGAN PEMBATAS (STOPPER)
        function createFlipper(x, y, side) {
            const f = Bodies.rectangle(x, y, 80, 20, { 
                chamfer: { radius: 10 }, 
                render: { fillStyle: '#ff0055' },
                collisionFilter: { group: -1 }
            });
            
            const pivotX = side === 'left' ? x - 35 : x + 35;
            const pivot = Constraint.create({
                pointA: { x: pivotX, y: y },
                bodyB: f,
                pointB: { x: side === 'left' ? -35 : 35, y: 0 },
                stiffness: 1, length: 0, render: { visible: false }
            });

            // Stopper agar tidak berputar 360 (Benda tak terlihat untuk menahan)
            const stopAngle = side === 'left' ? 0.5 : -0.5;
            const stopper = Bodies.circle(x, y + (side === 'left' ? 30 : 30), 5, { isStatic: true, isSensor: true });

            return { body: f, pivot };
        }

        const leftF = createFlipper(130, height - 100, 'left');
        const rightF = createFlipper(width - 180, height - 100, 'right');

        // 3. OBJEK BUMPER
        const bumpers = [
            Bodies.circle(130, 200, 30, { isStatic: true, restitution: 1.5, render: { fillStyle: '#00f2ff' } }),
            Bodies.circle(270, 200, 30, { isStatic: true, restitution: 1.5, render: { fillStyle: '#00f2ff' } }),
            Bodies.circle(200, 350, 35, { isStatic: true, restitution: 1.5, render: { fillStyle: '#ffaa00' } })
        ];

        // 4. BOLA
        let ball = Bodies.circle(width - 30, height - 50, 12, {
            restitution: 0.5, mass: 1, render: { fillStyle: '#fff' }
        });

        Composite.add(engine.world, [...walls, ...bumpers, leftF.body, leftF.pivot, rightF.body, rightF.pivot, ball]);

        // 5. LOGIKA KONTROL
        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if(e.code === 'Space' && !isGameOver) power = Math.min(power + 0.005, 0.15); // Cas tenaga
        });
        window.addEventListener('keyup', e => {
            keys[e.code] = false;
            if(e.code === 'Space' && !isGameOver) {
                Body.applyForce(ball, ball.position, { x: 0, y: -power });
                power = 0;
            }
        });

        // Touch Support
        window.addEventListener('touchstart', e => {
            const x = e.touches[0].clientX;
            if(x > width - 60) power = 0.1; // Auto power di mobile
            else if(x < width/2) keys['ArrowLeft'] = true;
            else keys['ArrowRight'] = true;
        });
        window.addEventListener('touchend', () => {
            if(power > 0) { Body.applyForce(ball, ball.position, { x: 0, y: -power }); power = 0; }
            keys['ArrowLeft'] = false; keys['ArrowRight'] = false;
        });

        // 6. UPDATE LOOP
        Events.on(engine, 'beforeUpdate', () => {
            if (keys['ArrowLeft']) Body.setAngularVelocity(leftF.body, -0.3);
            else Body.setAngle(leftF.body, 0.3); // Balik ke posisi asal

            if (keys['ArrowRight']) Body.setAngularVelocity(rightF.body, 0.3);
            else Body.setAngle(rightF.body, -0.3); // Balik ke posisi asal

            // Cek jika bola jatuh
            if(ball.position.y > height + 50 && !isGameOver) {
                ballLeft--;
                document.getElementById('ballCount').innerText = ballLeft;
                if(ballLeft <= 0) {
                    isGameOver = true;
                    document.getElementById('msg').style.display = 'block';
                } else {
                    Body.setPosition(ball, { x: width - 30, y: height - 50 });
                    Body.setVelocity(ball, { x: 0, y: 0 });
                }
            }
        });

        Events.on(engine, 'collisionStart', (e) => {
            e.pairs.forEach(p => {
                if(bumpers.includes(p.bodyA) || bumpers.includes(p.bodyB)) {
                    score += 100;
                    document.getElementById('score').innerText = score;
                }
            });
        });

        Render.run(render);
        Runner.run(Runner.create(), engine);
    </script>
</body>
</html>
