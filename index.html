<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pinball Pro - Final Wrap</title>
    <style>
        /* Memastikan body tidak bisa scroll dan konten di tengah */
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none; }
        
        /* Box utama dengan ukuran tetap */
        #game-box { position: relative; width: 400px; height: 600px; background: #050505; border: 4px solid #333; box-shadow: 0 0 20px rgba(0,255,255,0.2); }
        
        /* UI di dalam box */
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; color: #0ff; font-family: monospace; font-size: 16px; z-index: 10; pointer-events: none; }
        #power-bar { position: absolute; right: 8px; bottom: 20px; width: 8px; height: 80px; border: 1px solid #ffaa00; display: flex; align-items: flex-end; }
        #power-fill { width: 100%; height: 0%; background: #ffaa00; }
        #msg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: #ff0055; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 20; font-family: sans-serif; }
    </style>
</head>
<body>

    <div id="game-box">
        <div id="ui">
            <div>SKOR: <span id="score">0</span></div>
            <div>BOLA: <span id="ballCount">5</span>/5</div>
        </div>
        <div id="power-bar"><div id="power-fill"></div></div>
        <div id="msg">
            <h1>GAME OVER</h1>
            <button onclick="location.reload()" style="padding:10px 20px; background:#0ff; border:none; cursor:pointer; font-weight:bold;">MAIN LAGI</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        window.onload = () => {
            const { Engine, Render, Runner, Bodies, Composite, Body, Constraint, Events } = Matter;

            const box = document.getElementById('game-box');
            const width = 400;
            const height = 600;

            const engine = Engine.create();
            let score = 0;
            let ballLeft = 5;
            let power = 0;
            let isGameOver = false;

            const render = Render.create({
                element: box,
                engine: engine,
                options: { width, height, wireframes: false, background: 'transparent' }
            });

            // --- FISIKA PAPAN (TERTUTUP RAPAT) ---
            const wallOpt = { isStatic: true, render: { fillStyle: '#151515' }, restitution: 0.6 };
            
            const walls = [
                Bodies.rectangle(200, 10, 400, 20, wallOpt), // ATAP SOLID
                Bodies.rectangle(10, 300, 20, 600, wallOpt), // DINDING KIRI
                Bodies.rectangle(390, 300, 20, 600, wallOpt), // DINDING KANAN
                
                // JALUR PELUNCUR
                Bodies.rectangle(350, 450, 10, 300, wallOpt), // Sekat jalur
                Bodies.rectangle(375, 595, 50, 10, wallOpt), // Lantai rumah bola
                
                // PENGARAH ATAS (Mencegah bola nyangkut di pojok)
                Bodies.rectangle(60, 60, 150, 20, { isStatic: true, angle: 0.7, render: { fillStyle: '#252525' } }),
                Bodies.rectangle(300, 60, 150, 20, { isStatic: true, angle: -0.7, render: { fillStyle: '#252525' } }),

                // CORONG BAWAH
                Bodies.rectangle(60, 520, 140, 20, { isStatic: true, angle: 0.7, render: { fillStyle: '#222' } }),
                Bodies.rectangle(290, 520, 140, 20, { isStatic: true, angle: -0.7, render: { fillStyle: '#222' } })
            ];

            // --- FLIPPER ---
            function createFlipper(x, y, side) {
                const f = Bodies.rectangle(x, y, 80, 18, { 
                    chamfer: { radius: 9 }, render: { fillStyle: '#ff0055' }, collisionFilter: { group: -1 } 
                });
                const pivotX = side === 'left' ? x - 35 : x + 35;
                const pivot = Constraint.create({
                    pointA: { x: pivotX, y: y }, bodyB: f, pointB: { x: side === 'left' ? -35 : 35, y: 0 },
                    stiffness: 1, length: 0, render: { visible: false }
                });
                return { body: f, pivot };
            }
            const leftF = createFlipper(135, 550, 'left');
            const rightF = createFlipper(215, 550, 'right');

            // --- BUMPER ---
            const bumpers = [
                Bodies.circle(130, 200, 25, { isStatic: true, restitution: 1.5, render: { fillStyle: '#00f2ff' } }),
                Bodies.circle(270, 200, 25, { isStatic: true, restitution: 1.5, render: { fillStyle: '#00f2ff' } }),
                Bodies.circle(200, 330, 30, { isStatic: true, restitution: 1.5, render: { fillStyle: '#77ff00' } })
            ];

            // --- BOLA ---
            let ball = Bodies.circle(375, 570, 12, {
                restitution: 0.5, mass: 1, render: { fillStyle: '#fff' }
            });

            Composite.add(engine.world, [...walls, ...bumpers, leftF.body, leftF.pivot, rightF.body, rightF.pivot, ball]);

            // --- KONTROL ---
            const keys = {};
            document.addEventListener('keydown', e => {
                keys[e.code] = true;
                if(e.code === 'Space' && !isGameOver) {
                    power = Math.min(power + 0.005, 0.2);
                    document.getElementById('power-fill').style.height = (power * 500) + '%';
                }
            });
            document.addEventListener('keyup', e => {
                keys[e.code] = false;
                if(e.code === 'Space' && !isGameOver) {
                    Body.applyForce(ball, ball.position, { x: 0, y: -power });
                    power = 0;
                    document.getElementById('power-fill').style.height = '0%';
                }
            });

            // Touch Support (Batas area di dalam box)
            box.addEventListener('touchstart', e => {
                const x = e.touches[0].clientX - box.offsetLeft;
                if(x > 340) power = 0.16;
                else if(x < 200) keys['ArrowLeft'] = true;
                else keys['ArrowRight'] = true;
            });
            box.addEventListener('touchend', () => {
                if(power > 0) { Body.applyForce(ball, ball.position, { x: 0, y: -power }); power = 0; }
                keys['ArrowLeft'] = false; keys['ArrowRight'] = false;
            });

            // --- LOOP ---
            Events.on(engine, 'beforeUpdate', () => {
                if (keys['ArrowLeft']) Body.setAngularVelocity(leftF.body, -0.4);
                else Body.setAngle(leftF.body, 0.3);

                if (keys['ArrowRight']) Body.setAngularVelocity(rightF.body, 0.4);
                else Body.setAngle(rightF.body, -0.3);

                if(ball.position.y > 620 && !isGameOver) {
                    ballLeft--;
                    document.getElementById('ballCount').innerText = ballLeft;
                    if(ballLeft <= 0) {
                        isGameOver = true;
                        document.getElementById('msg').style.display = 'flex';
                    } else {
                        Body.setPosition(ball, { x: 375, y: 570 });
                        Body.setVelocity(ball, { x: 0, y: 0 });
                    }
                }
            });

            Events.on(engine, 'collisionStart', (e) => {
                e.pairs.forEach(p => {
                    if(bumpers.includes(p.bodyA) || bumpers.includes(p.bodyB)) {
                        score += 100;
                        document.getElementById('score').innerText = score;
                    }
                });
            });

            Render.run(render);
            Runner.run(Runner.create(), engine);
        };
    </script>
</body>
</html>
